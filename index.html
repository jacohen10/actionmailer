<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Actionmailer by jacohen10</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Actionmailer</h1>
      <h2 class="project-tagline"></h2>
      <a href="https://github.com/jacohen10/actionmailer" class="btn">View on GitHub</a>
      <a href="https://github.com/jacohen10/actionmailer/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/jacohen10/actionmailer/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="setting-up-actionmailer-with-gmail" class="anchor" href="#setting-up-actionmailer-with-gmail" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setting up ActionMailer with Gmail</h1>

<p>Overall, setting up ActionMailer within your rails app is pretty straightforward. However, if you're just starting out like I am, there are few small steps that can easily cause some missteps. Hopefully this tutorial will help you avoid making the same mistakes I did!</p>

<p>This tutorial assumes you know how to make a basic rails app with full CRUD functionality.</p>

<ul>
<li>Basic setup</li>
<li>Passing instance variables to your mailer</li>
<li>Common errors</li>
</ul>

<h2>
<a id="step-1-updating-configenvironmentsdevelopmentrb" class="anchor" href="#step-1-updating-configenvironmentsdevelopmentrb" aria-hidden="true"><span class="octicon octicon-link"></span></a>Step 1: Updating config/environments/development.rb</h2>

<p>For some reason rails turns error messages off for its mailer, so they're first thing we're going to do is turn that on. Find the code below in the development.rb file and set it to true</p>

<div class="highlight highlight-source-ruby"><pre>config.action_mailer.raise_delivery_errors <span class="pl-k">=</span> <span class="pl-c1">false</span></pre></div>

<div class="highlight highlight-source-ruby"><pre>config.action_mailer.raise_delivery_errors <span class="pl-k">=</span> <span class="pl-c1">true</span></pre></div>

<p>Next we'll add in your delivery method using Gmail. Add the following (you can add it anywhere, but I put it under the code we just set to true so that it's all together)</p>

<div class="highlight highlight-source-ruby"><pre>config.action_mailer.delivery_method <span class="pl-k">=</span> <span class="pl-c1">:smtp</span>

config.action_mailer.smtp_settings <span class="pl-k">=</span> {
<span class="pl-c1">address:</span> <span class="pl-s"><span class="pl-pds">"</span>smtp.gmail.com<span class="pl-pds">"</span></span>,
<span class="pl-c1">port:</span> <span class="pl-c1">587</span>,
<span class="pl-c1">domain:</span> <span class="pl-c1">ENV</span>[<span class="pl-s"><span class="pl-pds">"</span>GMAIL_DOMAIN<span class="pl-pds">"</span></span>],
<span class="pl-c1">authentication:</span> <span class="pl-s"><span class="pl-pds">"</span>plain<span class="pl-pds">"</span></span>,
<span class="pl-c1">enable_starttls_auto:</span> <span class="pl-c1">true</span>,
<span class="pl-c1">user_name:</span> <span class="pl-c1">ENV</span>[<span class="pl-s"><span class="pl-pds">"</span>GMAIL_USERNAME<span class="pl-pds">"</span></span>],
<span class="pl-c1">password:</span> <span class="pl-c1">ENV</span>[<span class="pl-s"><span class="pl-pds">"</span>GMAIL_PASSWORD<span class="pl-pds">"</span></span>]
}</pre></div>

<p>It's important to note the use of <code>ENV[""]</code> here. This is one step we take towards hiding sensitive information that we don't want posted to github for anyone to see. More on this later.</p>

<p>If you're using devise the following code should be at the bottom of development.rb file, but if not make sure you add it.</p>

<div class="highlight highlight-source-ruby"><pre>config.action_mailer.default_url_options <span class="pl-k">=</span> { <span class="pl-c1">host:</span> <span class="pl-s"><span class="pl-pds">'</span>localhost<span class="pl-pds">'</span></span>, <span class="pl-c1">port:</span> <span class="pl-c1">3000</span> }</pre></div>

<h2>
<a id="step-2-updating-configenvironmentsproductionrb" class="anchor" href="#step-2-updating-configenvironmentsproductionrb" aria-hidden="true"><span class="octicon octicon-link"></span></a>Step 2: Updating config/environments/production.rb</h2>

<p>Having mailers work in development is great, but let's quickly update our app so it's prepared for production as well(This assumes you're using)</p>

<p>Add the following code to your production.rb file. Make sure to update the host with your actual heroku app's url</p>

<div class="highlight highlight-source-ruby"><pre>config.action_mailer.default_url_options <span class="pl-k">=</span> { <span class="pl-c1">host:</span> <span class="pl-s"><span class="pl-pds">'</span>http://yoursite.herokuapp.com<span class="pl-pds">'</span></span> }

config.action_mailer.delivery_method <span class="pl-k">=</span> <span class="pl-c1">:smtp</span>

config.action_mailer.smtp_settings <span class="pl-k">=</span> {
<span class="pl-c1">address:</span> <span class="pl-s"><span class="pl-pds">"</span>smtp.gmail.com<span class="pl-pds">"</span></span>,
<span class="pl-c1">port:</span> <span class="pl-c1">587</span>,
<span class="pl-c1">domain:</span> <span class="pl-c1">ENV</span>[<span class="pl-s"><span class="pl-pds">"</span>GMAIL_DOMAIN<span class="pl-pds">"</span></span>],
<span class="pl-c1">authentication:</span> <span class="pl-s"><span class="pl-pds">"</span>plain<span class="pl-pds">"</span></span>,
<span class="pl-c1">enable_starttls_auto:</span> <span class="pl-c1">true</span>,
<span class="pl-c1">user_name:</span> <span class="pl-c1">ENV</span>[<span class="pl-s"><span class="pl-pds">"</span>GMAIL_USERNAME<span class="pl-pds">"</span></span>],
<span class="pl-c1">password:</span> <span class="pl-c1">ENV</span>[<span class="pl-s"><span class="pl-pds">"</span>GMAIL_PASSWORD<span class="pl-pds">"</span></span>]
}</pre></div>

<h2>
<a id="step-3-creating-our-mailer" class="anchor" href="#step-3-creating-our-mailer" aria-hidden="true"><span class="octicon octicon-link"></span></a>Step 3: Creating our mailer</h2>

<p>Now for the fun part, actually creating the mailer. In your command line enter the following. The last option for the command can be whatever you want. I chose welcome_user.</p>

<pre><code>$ rails generate mailer UserMailer welcome_user
</code></pre>

<p>You'll notice this creates a number of files for you.</p>

<pre><code>create  app/mailers/user_mailer.rb
create  app/mailers/application_mailer.rb
invoke  erb
create    app/views/user_mailer
create    app/views/layouts/mailer.text.erb
create    app/views/layouts/mailer.html.erb
create    app/views/user_mailer/welcome_user.text.erb
create    app/views/user_mailer/welcome_user.html.erb
invoke  test_unit
create    test/mailers/user_mailer_test.rb
create    test/mailers/previews/user_mailer_preview.rb
</code></pre>

<p>The first file we're going to modify out of these is app/mailers/user_mailer.rb. This assumes you have a user model already.</p>

<p>Let's edit it to look like this</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">UserMailer<span class="pl-e"> &lt; ApplicationMailer</span></span>
  <span class="pl-k">def</span> <span class="pl-en">order_ahead_email</span>(<span class="pl-smi">user</span>)
    <span class="pl-smi">@user</span> <span class="pl-k">=</span> user
    mail <span class="pl-c1">to:</span> user.email, <span class="pl-c1">subject:</span> <span class="pl-s"><span class="pl-pds">"</span>Welcome<span class="pl-pds">"</span></span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<p>This looks and behaves very much like a controller. You can see that we pass a in a user to the function and then set it as an instance variable so we can then use it in our views. We'll pass the actual user in our controller. I usually pass in more than just the user so that I can easily access them in the views as well.</p>

<p>Now we'll want to invoke the mailer action in our controller. Here I do it in the User controller, but you can place it wherever you want depending on when you want an email to be sent out.</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">UsersController<span class="pl-e"> &lt; ApplicationController</span></span>
  <span class="pl-k">def</span> <span class="pl-en">create</span>
    <span class="pl-smi">@user</span> <span class="pl-k">=</span> <span class="pl-c1">User</span>.<span class="pl-k">new</span>(params[<span class="pl-c1">:user</span>])
    <span class="pl-c1">UserMailer</span>.welcome_user(<span class="pl-smi">@user</span>).deliver_now
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<p>Next we get to customize the views. Some people only receive text files so it's good practice to make text emails, but I'll only be focusing on html emails</p>

<p>Short and sweet email:</p>

<div class="highlight highlight-text-html-basic"><pre>&lt;<span class="pl-ent">p</span>&gt;
  &lt;%=@user.name %&gt;, thank you for joining our site!
&lt;/<span class="pl-ent">p</span>&gt;</pre></div>

<h2>
<a id="step-4-using-our-sensitive-information-safely" class="anchor" href="#step-4-using-our-sensitive-information-safely" aria-hidden="true"><span class="octicon octicon-link"></span></a>Step 4: Using our sensitive information safely</h2>

<p>First let's get your mailer to work in development</p>

<p>Add this gem:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">gem</span> <span class="pl-s"><span class="pl-pds">'</span>figaro<span class="pl-pds">'</span></span></pre></div>

<p>In your command line</p>

<pre><code>$ bundle install
$ figaro install # creates config/application.yml
</code></pre>

<p>In your newly created config/application.yml file add</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-c1">GMAIL_DOMAIN:</span>gmail.com
<span class="pl-c1">GMAIL_USERNAME:</span>your user name here
<span class="pl-c1">GMAIL_PASSWORD:</span>your password here</pre></div>

<p>If your rails server is running make sure to turn it on and off.
Congrats, you did it!! Test it out by creating a user.</p>

<p>Lastly, to make it work in heroku go to your app's settings and under config variables enter in the same keys and values that are in your application.yml file.</p>

<p>Enjoy your new mailer :)</p>

<h2>
<a id="errors" class="anchor" href="#errors" aria-hidden="true"><span class="octicon octicon-link"></span></a>Errors</h2>

<p>If you're getting an authentication error go to your Gmail account's security settings and set permissions for "Less secure apps" to Enabled</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/jacohen10/actionmailer">Actionmailer</a> is maintained by <a href="https://github.com/jacohen10">jacohen10</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
