{"name":"Actionmailer","tagline":"","body":"# Setting up ActionMailer with Gmail\r\n\r\nOverall, setting up ActionMailer within your rails app is pretty straightforward. However, if you're just starting out like I am, there are few small steps that can easily cause some missteps. Hopefully this tutorial will help you avoid making the same mistakes I did!\r\n\r\nThis tutorial assumes you know how to make a basic rails app with full CRUD functionality.\r\n\r\n- Basic setup\r\n- Passing instance variables to your mailer\r\n- Common errors\r\n\r\n## Step 1: Updating config/environments/development.rb\r\n\r\n\r\nFor some reason rails turns error messages off for its mailer, so they're first thing we're going to do is turn that on. Find the code below in the development.rb file and set it to true\r\n\r\n```rb\r\nconfig.action_mailer.raise_delivery_errors = false\r\n```\r\n\r\n```rb\r\nconfig.action_mailer.raise_delivery_errors = true\r\n```\r\n\r\nNext we'll add in your delivery method using Gmail. Add the following (you can add it anywhere, but I put it under the code we just set to true so that it's all together)\r\n\r\n```rb\r\nconfig.action_mailer.delivery_method = :smtp\r\n\r\nconfig.action_mailer.smtp_settings = {\r\naddress: \"smtp.gmail.com\",\r\nport: 587,\r\ndomain: ENV[\"GMAIL_DOMAIN\"],\r\nauthentication: \"plain\",\r\nenable_starttls_auto: true,\r\nuser_name: ENV[\"GMAIL_USERNAME\"],\r\npassword: ENV[\"GMAIL_PASSWORD\"]\r\n}\r\n```\r\n\r\nIt's important to note the use of ```ENV[\"\"]``` here. This is one step we take towards hiding sensitive information that we don't want posted to github for anyone to see. More on this later.\r\n\r\nIf you're using devise the following code should be at the bottom of development.rb file, but if not make sure you add it.\r\n\r\n```rb\r\nconfig.action_mailer.default_url_options = { host: 'localhost', port: 3000 }\r\n```\r\n\r\n## Step 2: Updating config/environments/production.rb\r\n\r\nHaving mailers work in development is great, but let's quickly update our app so it's prepared for production as well(This assumes you're using)\r\n\r\nAdd the following code to your production.rb file. Make sure to update the host with your actual heroku app's url\r\n\r\n```rb\r\nconfig.action_mailer.default_url_options = { host: 'http://yoursite.herokuapp.com' }\r\n\r\nconfig.action_mailer.delivery_method = :smtp\r\n\r\nconfig.action_mailer.smtp_settings = {\r\naddress: \"smtp.gmail.com\",\r\nport: 587,\r\ndomain: ENV[\"GMAIL_DOMAIN\"],\r\nauthentication: \"plain\",\r\nenable_starttls_auto: true,\r\nuser_name: ENV[\"GMAIL_USERNAME\"],\r\npassword: ENV[\"GMAIL_PASSWORD\"]\r\n}\r\n```\r\n\r\n## Step 3: Creating our mailer\r\n\r\nNow for the fun part, actually creating the mailer. In your command line enter the following. The last option for the command can be whatever you want. I chose welcome_user.\r\n\r\n```\r\n$ rails generate mailer UserMailer welcome_user\r\n```\r\n\r\nYou'll notice this creates a number of files for you.\r\n\r\n```\r\ncreate  app/mailers/user_mailer.rb\r\ncreate  app/mailers/application_mailer.rb\r\ninvoke  erb\r\ncreate    app/views/user_mailer\r\ncreate    app/views/layouts/mailer.text.erb\r\ncreate    app/views/layouts/mailer.html.erb\r\ncreate    app/views/user_mailer/welcome_user.text.erb\r\ncreate    app/views/user_mailer/welcome_user.html.erb\r\ninvoke  test_unit\r\ncreate    test/mailers/user_mailer_test.rb\r\ncreate    test/mailers/previews/user_mailer_preview.rb\r\n```\r\n\r\nThe first file we're going to modify out of these is app/mailers/user_mailer.rb. This assumes you have a user model already.\r\n\r\nLet's edit it to look like this\r\n```rb\r\nclass UserMailer < ApplicationMailer\r\n  def order_ahead_email(user)\r\n    @user = user\r\n    mail to: user.email, subject: \"Welcome\"\r\n  end\r\nend\r\n```\r\n\r\nThis looks and behaves very much like a controller. You can see that we pass a in a user to the function and then set it as an instance variable so we can then use it in our views. We'll pass the actual user in our controller. I usually pass in more than just the user so that I can easily access them in the views as well.\r\n\r\nNow we'll want to invoke the mailer action in our controller. Here I do it in the User controller, but you can place it wherever you want depending on when you want an email to be sent out.\r\n\r\n```rb\r\nclass UsersController < ApplicationController\r\n  def create\r\n    @user = User.new(params[:user])\r\n    UserMailer.welcome_user(@user).deliver_now\r\n  end\r\nend\r\n```\r\n\r\nNext we get to customize the views. Some people only receive text files so it's good practice to make text emails, but I'll only be focusing on html emails\r\n\r\nShort and sweet email:\r\n```html\r\n<p>\r\n  <%=@user.name %>, thank you for joining our site!\r\n</p>\r\n```\r\n\r\n## Step 4: Using our sensitive information safely\r\n\r\nFirst let's get your mailer to work in development\r\n\r\nAdd this gem:\r\n\r\n```rb\r\ngem 'figaro'\r\n```\r\n\r\nIn your command line\r\n```\r\n$ bundle install\r\n$ figaro install # creates config/application.yml\r\n```\r\nIn your newly created config/application.yml file add\r\n\r\n```rb\r\nGMAIL_DOMAIN:gmail.com\r\nGMAIL_USERNAME:your user name here\r\nGMAIL_PASSWORD:your password here\r\n```\r\n\r\nCongrats, you did it!! Test it out by creating a user.\r\n\r\nLastly, to make it work in heroku go to your app's settings and under config variables enter in the same keys and values that are in your application.yml file.\r\n\r\nEnjoy your new mailer :)\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}